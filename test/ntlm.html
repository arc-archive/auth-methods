<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
    <script src="../node_modules/mocha/mocha.js"></script>
    <script src="../node_modules/chai/chai.js"></script>
    <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
    <script src="../node_modules/sinon/pkg/sinon.js"></script>
    
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <auth-method-ntlm></auth-method-ntlm>
      </template>
    </test-fixture>

    <script type="module">
    import '../auth-method-ntlm.js';
    suite('basic', () => {
      let element;
      setup(() => {
        element = fixture('basic');
      });

      test('Computes settings', () => {
        element.username = 'test-user';
        element.password = 'test-passwd';
        element.domain = 'test-domain';
        const settings = element.getSettings();
        assert.equal(settings.username, element.username, 'username is set');
        assert.equal(settings.password, element.password, 'password is set');
        assert.equal(settings.domain, element.domain, 'Domain is  set');
      });
    });

    suite('Validation', () => {
      let element;
      setup(() => {
        element = fixture('basic');
      });

      test('Not valid without username and password', (done) => {
        flush(() => {
          const result = element.validate();
          assert.isFalse(result);
          done();
        });
      });

      test('Valid with username and password', (done) => {
        element.username = 'test';
        element.password = 'test';
        flush(() => {
          const result = element.validate();
          assert.isTrue(result);
          done();
        });
      });

      test('Valid with username, password and domain', (done) => {
        element.username = 'test';
        element.password = 'password';
        element.domain = 'test';
        flush(() => {
          const result = element.validate();
          assert.isTrue(result);
          done();
        });
      });
    });

    suite('Settings notification', () => {
      let element;
      setup(() => {
        element = fixture('basic');
      });

      test('Dispatches `auth-settings-changed` event once', () => {
        let spy = sinon.stub();
        element.addEventListener('auth-settings-changed', spy);
        element.username = 'test';
        assert.isTrue(spy.calledOnce);
      });

      test('Invalid settings dispatched', function(done) {
        flush(() => {
          element.addEventListener('auth-settings-changed', function clb(e) {
            element.removeEventListener('auth-settings-changed', clb);
            assert.equal(e.detail.settings.username, '', 'username is empty');
            assert.equal(e.detail.settings.password, 'test', 'password is set');
            assert.equal(e.detail.settings.domain, '', 'Domain is empty');
            assert.equal(e.detail.type, 'ntlm', 'type is set');
            assert.isFalse(e.detail.valid, 'valid is false');
            done();
          });
          element.password = 'test';
        });
      });

      test('Valid settings dispatched', (done) => {
        element.username = 'test-username';
        element.password = 'test-password';
        flush(() => {
          element.addEventListener('auth-settings-changed', function clb(e) {
            element.removeEventListener('auth-settings-changed', clb);
            assert.equal(e.detail.settings.username, 'test-username', 'Username is set');
            assert.equal(e.detail.settings.password, 'test-password', 'Password is empty');
            assert.equal(e.detail.settings.domain, 'test-domain', 'Domain is set');
            assert.equal(e.detail.type, 'ntlm', 'type is set');
            assert.isTrue(e.detail.valid, 'valid is true');
            done();
          });
          element.domain = 'test-domain';
        });
      });
    });

    suite('Settings change event handling', () => {
      function fire(opts) {
        opts = opts || {};
        let event = new CustomEvent('auth-settings-changed', {
          detail: {
            type: opts.type || 'ntlm',
            valid: true,
            settings: {
              username: 'user',
              password: 'passwd',
              domain: 'domain'
            }
          },
          bubbles: true
        });
        (opts.node || document.body).dispatchEvent(event);
      }
      let element;
      setup(() => {
        element = fixture('basic');
      });

      test('Updates properties from the event', () => {
        fire();
        assert.equal(element.username, 'user');
        assert.equal(element.password, 'passwd');
        assert.equal(element.domain, 'domain');
      });

      test('Does not update values for other types.', () => {
        fire({
          type: 'oauth2'
        });
        assert.isUndefined(element.username);
        assert.isUndefined(element.password);
        assert.isUndefined(element.domain);
      });

      test('Does not update values if target is self.', () => {
        fire({
          node: element
        });
        assert.isUndefined(element.username);
        assert.isUndefined(element.password);
        assert.isUndefined(element.domain);
      });

      test('Does not dispatch settings change event', () => {
        let spy = sinon.stub();
        element.addEventListener('auth-settings-changed', spy);
        fire();
        assert.isFalse(spy.called);
      });
    });
    </script>

  </body>
</html>
