<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>
    <script src="../../../sinon/pkg/sinon.js"></script>

  </head>
  <body>
    <test-fixture id="password">
      <template>
        <auth-method-oauth2 grant-type="password"></auth-method-oauth2>
      </template>
    </test-fixture>

    <script type="module">
    import '../auth-method-oauth2.js';
    import {afterNextRender} from '../../../@polymer/polymer/lib/utils/render-status.js';
    import {AmfLoader} from './amf-loader.js';
    import {tap} from '../../../@polymer/iron-test-helpers/mock-interactions.js';

    suite('Code grant type', () => {
      let element;
      const clientId = '821776164331-rserncqpdsq32lmbf5cfeolgcoujb6fm.apps.googleusercontent.com';
      const authorizationUri = 'https://accounts.google.com/o/oauth2/v2/auth';
      const username = 'test-username';
      const password = 'test-password';
      const scopes = ['email', 'profile'];

      function clearCache() {
        sessionStorage.clear();
        const factory = document.createElement('api-view-model-transformer');
        factory.clearCache();
      }

      suite('Validation', () => {
        setup((done) => {
          clearCache();
          element = fixture('password');
          element.accessTokenUri = authorizationUri;
          element.clientId = clientId;
          element.username = username;
          afterNextRender(window, () => {
            flush(() => done());
          });
        });

        test('Should not be validated', () => {
          assert.isFalse(element.validate(), 'Active validation.');
        });

        test('Should be validated', (done) => {
          element.password = password;
          flush(() => {
            assert.isTrue(element.validate());
            done();
          });
        });

        test('Should not fire oauth2-token-requested event', () => {
          let spy = sinon.stub();
          element.accessTokenUri = undefined;
          element.addEventListener('oauth2-token-requested', spy);
          let button = element.shadowRoot.querySelector('.auth-button');
          tap(button);
          assert.isFalse(spy.calledOnce);
        });

        test('Fire oauth2-token-requested event', (done) => {
          element.password = password;
          flush(() => {
            const spy = sinon.stub();
            element.addEventListener('oauth2-token-requested', spy);
            const button = element.shadowRoot.querySelector('.auth-button');
            tap(button);
            assert.isTrue(spy.calledOnce);
            done();
          });
        });
      });

      suite('Fields visibility', () => {
        setup((done) => {
          clearCache();
          element = fixture('password');
          afterNextRender(window, () => {
            flush(() => done());
          });
        });

        teardown(() => {
          const factory = document.createElement('api-view-model-transformer');
          factory.clearCache();
        });

        test('Step 1 is closed per auto selection', () => {
          assert.isTrue(element.isSelectedType);
          const node = element.shadowRoot.querySelector('auth-method-step[step="1"]');
          assert.isTrue(node.inactive);
        });

        test('Client id is required', () => {
          const node = element.shadowRoot.querySelector('[data-input="clientid"]');
          assert.isTrue(node.required);
        });

        test('Client id is required', () => {
          const node = element.shadowRoot.querySelector('[data-input="clientid"]');
          assert.isTrue(node.required);
        });

        test('Client secret is required', () => {
          const node = element.shadowRoot.querySelector('[data-input="clientsecret"]');
          assert.isTrue(node.required);
        });

        test('Client secret is disabled', () => {
          const node = element.shadowRoot.querySelector('[data-input="clientsecret"]');
          assert.isTrue(node.disabled);
        });

        test('Client secret is hidden', () => {
          const node = element.shadowRoot.querySelector('[data-input="clientsecret"]');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'none');
        });

        test('Advanced settings checkbox is not rendered', () => {
          const node = element.shadowRoot.querySelector('.adv-settings-input');
          assert.notOk(node);
        });

        test('Authorization URI is hidden', () => {
          const node = element.shadowRoot.querySelector('[data-input="authuri"]');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'none');
        });

        test('Authorization URI is disabled', () => {
          const node = element.shadowRoot.querySelector('[data-input="authuri"]');
          assert.isTrue(node.disabled);
        });

        test('Authorization URI is required', () => {
          const node = element.shadowRoot.querySelector('[data-input="authuri"]');
          assert.isTrue(node.required);
        });

        test('Access token URI is not hidden', () => {
          const node = element.shadowRoot.querySelector('[data-input="tokenuri"]');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'block');
        });

        test('Access token URI is required', () => {
          const node = element.shadowRoot.querySelector('[data-input="tokenuri"]');
          assert.isTrue(node.required);
        });

        test('Access token URI is not disabled', () => {
          const node = element.shadowRoot.querySelector('[data-input="tokenuri"]');
          assert.isFalse(node.disabled);
        });

        test('Username is not hidden', () => {
          const node = element.shadowRoot.querySelector('[data-input="username"]');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'block');
        });

        test('Username is required', () => {
          const node = element.shadowRoot.querySelector('[data-input="username"]');
          assert.isTrue(node.required);
        });

        test('Username is not disabled', () => {
          const node = element.shadowRoot.querySelector('[data-input="username"]');
          assert.isFalse(node.disabled);
        });

        test('Password is not hidden', () => {
          const node = element.shadowRoot.querySelector('[data-input="password"]');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'block');
        });

        test('Password is required', () => {
          const node = element.shadowRoot.querySelector('[data-input="password"]');
          assert.isTrue(node.required);
        });

        test('Password is not disabled', () => {
          const node = element.shadowRoot.querySelector('[data-input="password"]');
          assert.isFalse(node.disabled);
        });

        test('Scope selector is not hidden', () => {
          const node = element.shadowRoot.querySelector('oauth2-scope-selector');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'block');
        });

        test('Request access token button is rendered', () => {
          const node = element.shadowRoot.querySelector('.authorize-actions');
          const display = getComputedStyle(node).display;
          assert.notEqual(display, 'none');
        });

        test('current-token section is hidden', () => {
          const node = element.shadowRoot.querySelector('.current-token');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'none');
        });
      });

      suite('Events', () => {
        setup((done) => {
          clearCache();
          element = fixture('password');
          element.clientId = clientId;
          element.accessTokenUri = authorizationUri;
          element.username = username;
          element.password = password;
          afterNextRender(window, () => {
            flush(() => done());
          });
        });

        test('oauth2-token-requested event contains state parameter', () => {
          let eventData;
          element.addEventListener('oauth2-token-requested', function clb(e) {
            element.removeEventListener('oauth2-token-requested', clb);
            eventData = e.detail;
          });
          const button = element.shadowRoot.querySelector('.auth-button');
          tap(button);
          assert.typeOf(eventData.state, 'string');
        });

        test('oauth2-token-requested event contains all required data', (done) => {
          element.addEventListener('oauth2-token-requested', function clb(e) {
            element.removeEventListener('oauth2-token-requested', clb);
            assert.equal(e.detail.type, 'password', 'type is set');
            assert.equal(e.detail.accessTokenUri, authorizationUri, 'accessTokenUri is set');
            assert.equal(e.detail.clientId, clientId, 'clientId is set');
            assert.equal(e.detail.username, username, 'username is set');
            assert.equal(e.detail.password, password, 'password is set');
            assert.typeOf(e.detail.customData, 'object', 'customData is set');
            done();
          });
          element.authorize();
        });
      });

      suite('getSettings()', () => {
        let element;
        setup(() => {
          clearCache();
          element = fixture('password');
          element.clientId = clientId;
          element.accessTokenUri = authorizationUri;
          element.username = username;
          element.password = password;
          element.scopes = scopes;
        });

        test('Returns an object', () => {
          let result = element.getSettings();
          assert.typeOf(result, 'object');
        });

        test('type is set', () => {
          let result = element.getSettings();
          assert.equal(result.type, element.grantType);
        });

        test('clientId is set', () => {
          let result = element.getSettings();
          assert.equal(result.clientId, clientId);
        });

        test('accessToken is set', () => {
          let result = element.getSettings();
          assert.equal(result.accessToken, '', 'Token value is empty');

          element.accessToken = 'test-token';
          result = element.getSettings();
          assert.equal(result.accessToken, element.accessToken, 'Token value is set');
        });

        test('accessTokenUri is set', () => {
          let result = element.getSettings();
          assert.equal(result.accessTokenUri, authorizationUri);
        });

        test('username is set', () => {
          let result = element.getSettings();
          assert.equal(result.username, username);
        });

        test('password is set', () => {
          let result = element.getSettings();
          assert.equal(result.password, password);
        });

        test('Custom values are empty', () => {
          const result = element.getSettings();
          assert.isUndefined(result.customData.auth, 'auth is not set');
          assert.isUndefined(result.customData.token.parameters, 'token params is not set');
          assert.isUndefined(result.customData.token.headers, 'token headers is not set');
          assert.isUndefined(result.customData.token.body, 'token body is not set');
        });

        test('deliveryMethod is set', () => {
          const result = element.getSettings();
          assert.equal(result.deliveryMethod, 'header', 'default value is set');
        });

        test('deliveryName is set', () => {
          const result = element.getSettings();
          assert.equal(result.deliveryName, 'authorization', 'default value is set');
        });

        test('scopes is set', () => {
          const result = element.getSettings();
          assert.typeOf(result.scopes, 'array');
          assert.deepEqual(result.scopes, scopes);
        });
      });

      suite('getSettings() - custom data', () => {
        [
          ['Full data model', false],
          ['Compact data model', true]
        ].forEach((setupItem) => {
          suite(setupItem[0], function() {
            let amf;
            let security;
            let element;
            suiteSetup(() => {
              return AmfLoader.load(0, setupItem[1])
              .then((model) => {
                amf = model[0];
                security = model[1];
              });
            });

            setup((done) => {
              clearCache();
              element = fixture('password');
              element.amfModel = amf;
              element.amfSettings = security;
              element.grantType = 'password';
              afterNextRender(element, () => {
                flush(() => done());
              });
            });

            test('Contains only required params', () => {
              const result = element.getSettings();
              assert.typeOf(result.customData.token.body, 'array', 'token body is an array');
              assert.lengthOf(result.customData.token.body, 1, 'has one item');
              assert.isUndefined(result.customData.token.headers, 'token headers is not set');
            });

            test('Contains not required data when added', () => {
              const value = 'test-aq';
              element.tokenQueryParameters[0].value = value;
              const result = element.getSettings();
              assert.lengthOf(result.customData.token.parameters, 1, 'has one item');
              assert.equal(result.customData.token.parameters[0].value, value);
            });

            test('deliveryMethod is set', () => {
              const result = element.getSettings();
              assert.equal(result.deliveryMethod, 'query', 'Custom value is set');
            });

            test('deliveryName is set', () => {
              const result = element.getSettings();
              assert.equal(result.deliveryName, 'access_token', 'Custom value is set');
            });

            test('deliveryMethod is restored to default', () => {
              element.amfSettings = undefined;
              const result = element.getSettings();
              assert.equal(result.deliveryMethod, 'header');
            });

            test('deliveryName is restored to default', () => {
              element.amfSettings = undefined;
              const result = element.getSettings();
              assert.equal(result.deliveryName, 'authorization');
            });
          });
        });
      });
    });
    </script>
  </body>
</html>
